<!DOCTYPE html>
<html>
<head>
    <title>Hello, WebVR! - A-Frame</title>
    <meta name="description" content="Hello, WebVR! - A-Frame">
    <script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
    <script src="//unpkg.com/aframe-leap-hands/dist/aframe-leap-hands.min.js"></script>
    <script src="../js/TransformControls.js"></script>
    <script>

        var selectHand = function (i)
        {
            switch (i)
            {
                case 3:
                    //selezione della posizione del pollice sui tre assi
                    if(hand.type === 'right' && document.querySelector('#r').components['leap-hand'].getHand() !== null && document.querySelector('#r').components['leap-hand'].getHand() !== undefined && document.querySelector('#r').components['leap-hand'].getHand())
                        handTick = document.querySelector('#r').components['leap-hand'].getHand().pointables[0].tipPosition;
                    else if(hand.type === 'left' && document.querySelector('#l').components['leap-hand'].getHand() !== null && document.querySelector('#l').components['leap-hand'].getHand() !== undefined && document.querySelector('#l').components['leap-hand'].getHand())
                        handTick = document.querySelector('#l').components['leap-hand'].getHand().pointables[0].tipPosition;
                    break;
                default:
                    //selezione della posizione del pollice sui tre assi
                    if(hand.type === 'right' && document.querySelector('#r').components['leap-hand'].getHand() !== null && document.querySelector('#r').components['leap-hand'].getHand() !== undefined && document.querySelector('#r').components['leap-hand'].getHand())
                        handTick = document.querySelector('#r').components['leap-hand'].getHand().pointables[0].tipPosition[i];
                    else if(hand.type === 'left' && document.querySelector('#l').components['leap-hand'].getHand() !== null && document.querySelector('#l').components['leap-hand'].getHand() !== undefined && document.querySelector('#l').components['leap-hand'].getHand())
                        handTick = document.querySelector('#l').components['leap-hand'].getHand().pointables[0].tipPosition[i];
            }
            return handTick;
        };

        var firstHandPosition = null; //posizione della mano nel momento in cui viene chiamato l'evento leap-holdstart
        var flag = false; //indica se l'evento sia stato emesso o meno
        var target = null; //oggetto da trasformare
        var hand = null; //mano che innesca l'evento
        var targetOriginalRotation = null; //valore iniziale del target per somma posizione
        var axis = null; //asse scelto per la modifica
        var el = null; //variabile d'appoggio
        var i = null; //indice asse

        /* vedere: getBoundingClientRect method */
        AFRAME.registerComponent('holdable', {

            init: function ()
            {
                this.el.addEventListener('leap-holdstart', this.onHoldStart.bind(this));
                this.el.addEventListener('leap-holdstop', this.onHoldStop.bind(this));
                el = this.el;
            },

            tick: function()
            {
                var handTick = null; //posizione del pollice nel tick corrente
                if(flag)
                {
                    //controllo sull'asse selezionato: tutti, x, y, z
                    if(axis === 'all')
                        i = 3;
                    else if(axis === 'x')
                        i = 0;
                    else if(axis === 'y')
                        i = 1;
                    else if(axis === 'z')
                        i = 2;

                    //i = 0; //funzione manuale

                    if(i !== null) {
                        //selezione posizione mano in base all'asse
                        //handTick = selectHand(i);

                        //if(handTick !== null)
                        {
                            //modifica della scalatura in base all'asse scelto (differenza tra posizione pollice in holdstart e ad ogni tick)
                            switch (i)
                            {
                                case 0:
                                    if(selectHand(1) !== null) {
                                        handTick = selectHand(1);
                                        target.setAttribute('rotation', (targetOriginalRotation.x + ((handTick - firstHandPosition[1]) * 360)) + ' ' + targetOriginalRotation.y + ' ' + targetOriginalRotation.z);
                                        console.log((targetOriginalRotation.x + ((handTick - firstHandPosition[1]) * 360)) + ' ' + targetOriginalRotation.y + ' ' + targetOriginalRotation.z);
                                    } else
                                    //emette l'evento stop perché la mano non è più visibile
                                        el.emit('leap-holdstop');
                                    break;
                                case 1:
                                    if(selectHand(0) !== null) {
                                        handTick = selectHand(0);
                                        target.setAttribute('rotation', targetOriginalRotation.x + ' ' + (targetOriginalRotation.y + ((handTick - firstHandPosition[0]) * 360)) + ' ' + targetOriginalRotation.z);
                                        console.log(targetOriginalRotation.x + ' ' + (targetOriginalRotation.y + ((handTick - firstHandPosition[0]) * 360)) + ' ' + targetOriginalRotation.z);
                                    } else
                                    //emette l'evento stop perché la mano non è più visibile
                                        el.emit('leap-holdstop');
                                    break;
                                case 2:
                                    if(selectHand(1) !== null && selectHand(0) !== null) {
                                        handTick0 = selectHand(0);
                                        handTick1 = selectHand(1);
                                        target.setAttribute('rotation', targetOriginalRotation.x + ' ' + targetOriginalRotation.y + ' ' + (targetOriginalRotation.z + ((handTick0 - firstHandPosition[0] + handTick1 - firstHandPosition[1]) * 180)));
                                        console.log(targetOriginalRotation.x + ' ' + targetOriginalRotation.y + ' ' + (targetOriginalRotation.z + ((handTick0 - firstHandPosition[0] + handTick1 - firstHandPosition[1]) * 180)));
                                    } else
                                    //emette l'evento stop perché la mano non è più visibile
                                        el.emit('leap-holdstop');
                                    break;
                                case 3:
                                    if(selectHand(3) !== null) {
                                        handTick = selectHand(3);
                                        target.setAttribute('rotation', (targetOriginalRotation.x + ((handTick[1] - firstHandPosition[1]) * 360)) + ' ' + (targetOriginalRotation.y + ((handTick[0] - firstHandPosition[0]) * 360)) + ' ' + (targetOriginalRotation.z + ((handTick[0] - firstHandPosition[0] + handTick[1] - firstHandPosition[1]) * 180)));
                                        console.log((targetOriginalRotation.x + ((handTick[1] - firstHandPosition[1]) * 360)) + ' ' + (targetOriginalRotation.y + ((handTick[0] - firstHandPosition[0]) * 360)) + ' ' + (targetOriginalRotation.z + ((handTick[0] - firstHandPosition[0] + handTick[1] - firstHandPosition[1]) * 180)));
                                    } else
                                    //emette l'evento stop perché la mano non è più visibile
                                        el.emit('leap-holdstop');
                                    break;
                            }
                        }
                        /*else
                        //emette l'evento stop perché la mano non è più visibile
                            el.emit('leap-holdstop');*/
                    }
                }
                else
                    targetOriginalRotation = i = hand = target = null;
            },

            onHoldStart: function (e)
            {
                axis = e.srcElement.id;
                if(e.detail.hand !== null && e.detail !== undefined && e.detail.hand)
                {
                    console.log('leap-holdstart');
                    console.log(e);
                    //assegnamento mano che innescato l'evento
                    hand = e.detail.hand;
                    firstHandPosition = e.detail.hand.pointables[0].tipPosition;
                    target = document.querySelector('a-box'); //per ora funziona solo sulla sfera
                    flag = true;
                    //salvataggio colore precedente
                    oldColor = document.querySelector('#' + axis).getAttribute('color');
                    document.querySelector('#' + axis).setAttribute('color', '#ffff00');
                    //salvataggio posizione precedente
                    targetOriginalRotation = target.getAttribute('rotation');
                }
            },

            onHoldStop: function (e)
            {
                console.log('leap-holdstop');
                console.log(e);
                //l'evento emesso è stato "stoppato"
                flag = false;
                //assegnamento colore precedente
                document.querySelector('#' + axis).setAttribute('color', oldColor);
            }
        });
    </script>
</head>
<body>
<a-scene inspector leap="vr: false">
    <a-sky color="#000000"></a-sky>
    <a-entity id="camera" camera="near: 0.01" look-controls position="0 1.5 0"></a-entity>
    <a-entity id="l" leap-hand="hand: left; holdDistance: 0.5" position="0 1.25 -0.5"></a-entity>
    <a-entity id="r" leap-hand="hand: right; holdDistance: 0.5" position="0 1.25 -0.5"></a-entity>

    <a-entity id="transform" position="0 1.5 -0.5" scale="0.75 0.75 0.75">
        <a-cylinder id="x" position="0 0 0" color="#ff0000" scale="0.05 0.05 0.05" holdable geometry="radius: 0.25; height: 10"></a-cylinder>
        <a-cylinder id="y" position="0 0 0" color="#00ff00" scale="0.05 0.05 0.05" holdable rotation="0 0 90" geometry="radius: 0.25; height: 10"></a-cylinder>
        <a-torus id="z" position="0 0 0" color="#0000ff" scale="0.05 0.05 0.05" holdable rotation="0 0 0" geometry="radius: 5; radiusTubular: 0.1; segmentsRadial: 100; segmentsTubular: 100"></a-torus>
        <a-torus id="all" position="0 0 0" color="#ffffff" scale="0.05 0.05 0.05" holdable material="opacity: 0.5" rotation="0 0 0" geometry="radius: 6.5; radiusTubular: 0.1; segmentsRadial: 100; segmentsTubular: 100"></a-torus>
    </a-entity>

    <a-box position="0 1.5 -1.5" color="#4CC3D9"></a-box>
    <!--<a-sphere position="0 1.25 -3" radius="1.25" color="#EF2D5E"></a-sphere>!-->
    <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
</a-scene>
</body>
</html>
